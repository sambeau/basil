---
id: BUG-019
title: "Array toCSV sorts dictionary keys alphabetically instead of preserving insertion order"
status: resolved
severity: medium
created: 2026-02-07
reporter: "@human"
---

# BUG-019: Array toCSV sorts dictionary keys alphabetically instead of preserving insertion order

## Summary
The array `.toCSV()` method sorts dictionary keys alphabetically for the header row instead of preserving insertion order, contradicting Parsley's dictionary ordering guarantee.

## Observed Behavior
```parsley
let people = [{name: "Alice", age: 30}, {name: "Bob", age: 25}]
people.toCSV()
// "age,name\n30,Alice\n25,Bob\n"
```
Keys appear as `age,name` (alphabetical) instead of `name,age` (insertion order).

## Expected Behavior
```parsley
let people = [{name: "Alice", age: 30}, {name: "Bob", age: 25}]
people.toCSV()
// "name,age\nAlice,30\nBob,25\n"
```
Keys should appear as `name,age` (insertion order), consistent with how dictionaries work everywhere else in Parsley.

## Reproduction Steps
1. Create an array of dictionaries with keys in a specific order
2. Call `.toCSV()` on the array
3. Observe that the header row has keys sorted alphabetically

## Environment
- All platforms affected

---

## Investigation Notes

### Root Cause
In `encodeCSV()` (`pkg/parsley/evaluator/eval_encoders.go`), the function iterates over `firstDict.Pairs` (a Go map with random iteration order) and then calls `sort.Strings(headers)`. This ignores the `Dictionary.KeyOrder` field which tracks insertion order.

The `Dictionary` type has a `Keys()` method that returns keys in insertion order, but `encodeCSV` doesn't use it.

### Affected Code
- `pkg/parsley/evaluator/eval_encoders.go:155-165` — iterates map keys and sorts alphabetically
- `docs/parsley/manual/features/data-formats.md:144-145` — documents the bug as expected behavior

### Contrast with Table.toCSV
The `tableToCSV()` function in `stdlib_table.go` does NOT have this bug — it uses `t.Columns` which preserves column order correctly.

## Resolution

### Fix Description
- `pkg/parsley/evaluator/eval_encoders.go`: Changed `encodeCSV` to use `firstDict.Keys()` (which returns keys in insertion order) instead of iterating `firstDict.Pairs` map. Removed `sort.Strings(headers)` call and unused `sort` import.
- `docs/parsley/manual/features/data-formats.md`: Fixed example output to show insertion order (`name,age`) instead of alphabetical (`age,name`). Removed the warning about alphabetical sorting.

### Test Coverage
- Added regression test `toCSV preserves dictionary insertion order (BUG-019)` in `pkg/parsley/tests/process_test.go` that asserts header starts with `name,age\n` (insertion order).

## Related
- BUG-015: Schema `.as()` changes table column order to alphabetical (same class of bug)
- Related features: Dictionary insertion order guarantee