---
id: BUG-018
title: "Schema field metadata ignored when field has default value"
status: resolved
severity: medium
created: 2026-01-16
reporter: "@human"
---

# BUG-018: Schema field metadata ignored when field has default value

## Summary
When a schema field has both a default value AND metadata (using pipe syntax), the metadata is silently ignored.

## Observed Behavior
```parsley
@schema T { 
    x: int = 0 | {hidden: true} 
}
T.visibleFields()  // Returns ["x"]
```

The field `x` appears in `visibleFields()` despite having `hidden: true` in its metadata.

## Expected Behavior
```parsley
@schema T { 
    x: int = 0 | {hidden: true} 
}
T.visibleFields()  // Should return []
```

The metadata should be applied regardless of whether there's a default value. A field with `hidden: true` should be excluded from `visibleFields()`.

## Reproduction Steps
1. Create a schema with a field that has both a default value and metadata:
   ```parsley
   @schema Test { createdAt: datetime = @now | {hidden: true} }
   ```
2. Call `Test.visibleFields()`
3. Observe that `createdAt` is included in the result

## Environment
- OS: macOS
- Go version: 1.24+
- Basil version: v0.2.0

---
<!-- BELOW THIS LINE: AI-FOCUSED INVESTIGATION DETAILS -->

## Investigation Notes

### Root Cause
In `parseSchemaField()` in parser.go, the order of parsing was wrong:
1. First it checked for metadata pipe syntax (`| {hidden: true}`)
2. Then it checked for default value (`= expression`)

But the actual syntax `type = default | {metadata}` has the default BEFORE the metadata.

When parsing `= 5 | {hidden: true}`, the expression parser consumed the entire thing as a single expression: `5 | {hidden: true}` (a bitwise/union OR operation between an integer and a dictionary).

### Affected Code
- `pkg/parsley/parser/parser.go:2970-3010` — `parseSchemaField()` function

## Resolution

### Fix Description
Changed the parsing order in `parseSchemaField()`:
1. Parse default value FIRST (if `=` token present)
2. After parsing the default expression, check if it's a binary OR with a dictionary on the right side
3. If so, split: the left side becomes `DefaultValue`, the dictionary becomes `Metadata`
4. Then check for metadata pipe syntax for fields WITHOUT default values

This correctly handles both syntaxes:
- `type | {metadata}` — no default
- `type = default | {metadata}` — with default

### Test Coverage
Added two new tests in `record_test.go`:
- `TestSchemaMetadataWithDefaultValue` — verifies hidden fields work with defaults
- `TestSchemaMetadataTitleWithDefault` — verifies title metadata works with defaults
