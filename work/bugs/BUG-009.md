---
id: BUG-009
title: "Concurrent map writes crash in module cache"
status: fixed
severity: critical
created: 2025-12-02
fixed: 2025-12-02
---

# BUG-009: Concurrent map writes crash in module cache

## Summary
When multiple HTTP requests import modules simultaneously, the server crashes with "fatal error: concurrent map writes" due to unprotected access to the global module cache. Additionally, false "circular dependency" errors occurred due to cross-request pollution of the `loading` state.

## Reproduction
1. Start Basil server with a handler that imports a module
2. Send multiple concurrent HTTP requests (e.g., browser refresh + another tab)
3. Server crashes with panic, or reports false circular dependency errors

## Stack Trace
```
fatal error: concurrent map writes

goroutine 15 [running]:
github.com/sambeau/basil/pkg/parsley/evaluator.evalImport({...}, 0x14000074780)
    /Users/samphillips/Dev/basil/pkg/parsley/evaluator/evaluator.go:7946 +0x548
```

## Root Cause
Two issues:

1. **Concurrent map access**: The `moduleCache` global variable was accessed without synchronization, causing crashes when multiple goroutines wrote simultaneously.

2. **Cross-request state pollution**: The `loading` map tracked in-flight imports globally, but `ClearModuleCache()` was called per-request. This caused:
   - Request A starts importing `page.pars`, sets `loading["page.pars"] = true`
   - Request B calls `ClearModuleCache()`, clears A's loading state
   - Request B starts importing, sets its own `loading["page.pars"] = true`
   - Request A continues, sees `loading["page.pars"]` from B, thinks circular!

## Fix
1. Added `sync.RWMutex` to `ModuleCache` for thread-safe cache access
2. Moved `loading` tracking from global cache to per-environment `importStack`
   - Each request has its own Environment with its own import stack
   - Circular dependency detection now only considers the current request's imports
   - No cross-request pollution possible

## Files Changed
- `pkg/parsley/evaluator/evaluator.go`:
  - Added `importStack` field to Environment struct
  - Removed `loading` map from ModuleCache
  - Updated evalImport to use environment's importStack for cycle detection
  - Used RWMutex for cache-only operations

## Testing
- Existing tests pass
- Race detector doesn't flag issues
- Manual testing with rapid concurrent requests
