---
id: BUG-020
title: "PLN serializer test flake: non-deterministic map key ordering in makeDict helper"
status: resolved
severity: low
created: 2026-02-09
reporter: "@human"
---

# BUG-020: PLN serializer test flake: non-deterministic map key ordering in makeDict helper

## Summary
`TestSerializeNested` in `pkg/parsley/pln/serializer_test.go` flakes because the `makeDict` test helper iterates a Go `map` to populate `KeyOrder`, producing non-deterministic insertion order.

## Observed Behavior
`TestSerializeNested` intermittently fails with output like:

```
expected "{items: [{id: 1, name: \"Item 1\"}, {id: 2, name: \"Item 2\"}], total: 2}",
got     "{total: 2, items: [{id: 1, name: \"Item 1\"}, {id: 2, name: \"Item 2\"}]}"
```

The top-level keys (`items`, `total`) and nested dict keys (`id`, `name`) can appear in any order across runs.

## Expected Behavior
The test should pass deterministically regardless of Go's map iteration order.

## Reproduction Steps
1. Run `go test ./pkg/parsley/pln/ -run TestSerializeNested -count=100`
2. Observe that some runs fail due to key ordering mismatch

## Environment
- OS: macOS / Linux
- Go version: 1.24+
- Basil version: development (main branch)

---

## Investigation Notes

### Root Cause
The `makeDict` helper in `serializer_test.go` (line 12) accepts a `map[string]evaluator.Object` and iterates it with `for k, v := range pairs` to build `KeyOrder`. Go maps have non-deterministic iteration order, so `KeyOrder` gets populated in a random order each run.

The serializer's `serializeDict` method correctly uses `d.Keys()` which returns `KeyOrder` as-is (preserving insertion order). The problem is that "insertion order" is random because the test helper inserts from a Go map.

### Affected Code
- `pkg/parsley/pln/serializer_test.go:12-22` — `makeDict` helper iterates Go map to build `KeyOrder`
- `pkg/parsley/pln/serializer_test.go:165-191` — `TestSerializeNested` expects a specific key order in the output

### Proposed Fix
Sort the keys in `makeDict` before iterating, so `KeyOrder` is always alphabetical:

```go
func makeDict(pairs map[string]evaluator.Object) *evaluator.Dictionary {
	d := &evaluator.Dictionary{
		Pairs:    make(map[string]ast.Expression),
		KeyOrder: []string{},
	}
	keys := make([]string, 0, len(pairs))
	for k := range pairs {
		keys = append(keys, k)
	}
	sort.Strings(keys)
	for _, k := range keys {
		v := pairs[k]
		d.Pairs[k] = &ast.ObjectLiteralExpression{Obj: v}
		d.KeyOrder = append(d.KeyOrder, k)
	}
	return d
}
```

This ensures tests have deterministic key order (alphabetical), which matches what the test expectations already assume.

## Resolution

### Fix Description
Sorted keys in the `makeDict` test helper before inserting into `KeyOrder`, ensuring deterministic alphabetical ordering regardless of Go's map iteration order. Added `sort` import.

### Test Coverage
Ran `TestSerializeNested` 50 times with `-count=50` — all passes. Full `pkg/parsley/pln` test suite (70 tests) passes.

## Related
- Discovered during: PLAN-081 lint cleanup
- Related features: none
- Related bugs: none