# BUG-015: Schema .as() changes table column order to alphabetical

**Status**: resolved  
**Reported**: 2026-01-16  
**Resolved**: 2026-01-16  
**Severity**: medium  
**Component**: parsley/evaluator

## Summary

Applying a schema to a table via `.as(Schema)` changes the column order to alphabetical instead of preserving the order defined in the schema.

## Observed Behavior

When applying a schema to a table, the columns are reordered alphabetically:

```json
{
  "Age": 20,
  "Birthday": "22 April 2005",
  "Firstname": "Solly",
  "Name": "Solly Phillips",
  "Surname": "Phillips",
  "id": 1
}
```

## Expected Behavior

Columns should maintain the order defined in the schema:

```parsley
@schema Birthday {
    id: id,
    Name: string,
    Firstname: string,
    Surname: string,
    Birthday: date
    Age: int,
}
```

Expected order: id, Name, Firstname, Surname, Birthday, Age

## Reproduction Steps

1. Define a schema with specific field order
2. Create a table from a query using `.map()`
3. Apply the schema with `.as(SchemaName)`
4. Observe that column order is alphabetical, not schema order

```parsley
@query(People ??->*)
    .map(fn({Firstname, Surname, Day, Month, Year, id}){
        dob = @({Year}-{Month}-{Day})
        age = floor((@today - dob) / @1y)
        {
            id: id,
            Name: Firstname + " " + Surname,
            Firstname: Firstname,
            Surname: Surname,
            Birthday: dob.format("long","en_GB")
            Age: age,
        }
    }).as(Birthday)
```

## Investigation Notes

Root cause identified in `BindSchemaToTable` in [record.go](../../pkg/parsley/evaluator/record.go):

```go
// Before fix - sorted alphabetically
columns := make([]string, 0, len(schema.Fields))
for name := range schema.Fields {
    columns = append(columns, name)
}
sort.Strings(columns)  // <-- This caused alphabetical ordering
```

The `schema.Fields` map doesn't preserve insertion order (Go maps are unordered), and the code was explicitly sorting the column names alphabetically.

## Resolution

**Commit**: 4b1c436, follow-up commit for `.rows` issue

Added `FieldOrder []string` field to `DSLSchema` struct to preserve declaration order:

1. **stdlib_dsl_schema.go**: Added `FieldOrder` field and populated it during `evalSchemaDeclaration`
2. **record.go**: Modified `BindSchemaToTable` to use `schema.FieldOrder` when available
3. **record.go** (follow-up): Modified `CreateRecord` to use `schema.FieldOrder` for `KeyOrder` so that `.rows` returns dictionaries with correct field order

```go
// After fix - uses schema declaration order
var columns []string
if len(schema.FieldOrder) > 0 {
    columns = schema.FieldOrder
} else {
    // Fallback for backwards compatibility
    columns = make([]string, 0, len(schema.Fields))
    for name := range schema.Fields {
        columns = append(columns, name)
    }
    sort.Strings(columns)
}
```

The fallback ensures backwards compatibility for any programmatically-created schemas that don't have `FieldOrder` set.

**Regression tests**: 
- `TestSchemaFieldOrderPreserved` - verifies `table.columns` order
- `TestSchemaRowFieldOrderPreserved` - verifies `table.rows[n].keys()` order
