---
id: BUG-021
title: "Duration multiplication is not commutative: `3 * @1d` fails but `@1d * 3` works"
status: resolved
severity: medium
created: 2026-02-08
reporter: "@human"
---

# BUG-021: Duration multiplication is not commutative

## Summary
Multiplying an integer by a duration (`3 * @1d`) fails with an operator error, while the reverse (`@1d * 3`) works correctly. Multiplication should be commutative.

## Observed Behavior
```parsley
>> @1d * 3
{__type: "duration", months: 0, seconds: 259200}  // ✓ Works (3 days)

>> 3 * @1d
Runtime error: line 1, column 3
  Operator '*' not supported for types integer and dictionary
```

## Expected Behavior
Both expressions should return the same result:
```parsley
>> 3 * @1d
{__type: "duration", months: 0, seconds: 259200}  // Should work (3 days)

>> @1d * 3
{__type: "duration", months: 0, seconds: 259200}  // Already works
```

## Reproduction Steps
1. Start the REPL: `pars`
2. Enter `@1d * 3` — works correctly
3. Enter `3 * @1d` — fails with operator error

## Environment
- OS: Any
- Go version: 1.24+
- Basil version: development

---

## Investigation Notes

### Root Cause
In `pkg/parsley/evaluator/eval_infix.go`, the infix expression evaluator handles `DICTIONARY_OBJ * INTEGER_OBJ` (duration * integer) but does not handle `INTEGER_OBJ * DICTIONARY_OBJ` (integer * duration).

Current code at line ~131:
```go
case left.Type() == DICTIONARY_OBJ && right.Type() == INTEGER_OBJ:
    if dict := left.(*Dictionary); isDatetimeDict(dict) {
        return evalDatetimeIntegerInfixExpression(tok, operator, dict, right.(*Integer))
    }
    if dict := left.(*Dictionary); isDurationDict(dict) {
        return evalDurationIntegerInfixExpression(tok, operator, dict, right.(*Integer))
    }
    // ... falls through to error
```

The reverse case at line ~136 only handles datetime, not duration:
```go
case left.Type() == INTEGER_OBJ && right.Type() == DICTIONARY_OBJ:
    if dict := right.(*Dictionary); isDatetimeDict(dict) {
        return evalIntegerDatetimeInfixExpression(tok, operator, left.(*Integer), dict)
    }
    // Missing: duration case
    return newOperatorErrorWithPos(...)
```

### Affected Code
- `pkg/parsley/evaluator/eval_infix.go:136-140` — Missing `isDurationDict` check for integer * dictionary case

### Proposed Fix
Add duration handling to the `INTEGER_OBJ * DICTIONARY_OBJ` case:

```go
case left.Type() == INTEGER_OBJ && right.Type() == DICTIONARY_OBJ:
    if dict := right.(*Dictionary); isDatetimeDict(dict) {
        return evalIntegerDatetimeInfixExpression(tok, operator, left.(*Integer), dict)
    }
    // Add this block:
    if dict := right.(*Dictionary); isDurationDict(dict) {
        // For multiplication, just swap operands (commutative)
        if operator == "*" {
            return evalDurationIntegerInfixExpression(tok, operator, dict, left.(*Integer))
        }
        // integer / duration doesn't make sense, fall through to error
    }
    return newOperatorErrorWithPos(tok, "OP-0001", map[string]any{...})
```

Note: Only multiplication is commutative. `3 / @1d` (integer divided by duration) doesn't have a meaningful interpretation and should remain an error.

### Test Coverage Needed
Add test cases in `pkg/parsley/tests/duration_test.go` (or similar):
```go
{"3 * @1d", "{__type: \"duration\", ...}"},   // integer * duration
{"@1d * 3", "{__type: \"duration\", ...}"},   // duration * integer (existing)
{"3 * @2h30m", "..."},                         // integer * complex duration
{"-2 * @1d", "..."},                           // negative integer * duration
```

## Resolution
**Status:** Fixed  
**Date:** 2025-01-15  
**Commit:** (pending commit)

### Fix Description
Added support for `INTEGER_OBJ * DICTIONARY_OBJ` case in `eval_infix.go` to handle integer * duration multiplication. The fix checks if the right operand is a duration dictionary and, for the multiplication operator, swaps the operands to call the existing `evalDurationIntegerInfixExpression` function.

**Changes made:**
1. Added duration check in the `INTEGER_OBJ * DICTIONARY_OBJ` case (line ~139 in `eval_infix.go`)
2. For multiplication operator, swaps operands to reuse existing `evalDurationIntegerInfixExpression`
3. Division operation (`3 / @1d`) correctly remains unsupported (no mathematical meaning)

### Test Coverage
Added 5 new test cases to `pkg/parsley/tests/duration_test.go`:
- `multiply_integer_by_duration_(commutative)` - Tests `3 * @2h`
- `multiply_integer_by_simple_duration` - Tests `3 * @1d`
- `multiply_integer_by_compound_duration` - Tests `2 * @2h30m`
- `multiply_negative_integer_by_duration` - Tests `-2 * @1d`
- `commutativity:_duration_*_int_equals_int_*_duration` - Tests `(@2h * 3) == (3 * @2h)`

Also added error test case:
- `integer_divided_by_duration_is_not_supported` - Verifies `3 / @1d` remains an error

All 93 duration tests pass successfully.

## Related
- Source: BACKLOG item #52
- Report: `work/reports/PARSLEY-1.0-ALPHA-READINESS.md`
- Related features: Duration arithmetic (FEAT-087)