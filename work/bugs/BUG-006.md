---
id: BUG-006
title: "Images break after live reload"
status: resolved
severity: medium
created: 2025-12-01
reporter: "@human"
---

# BUG-006: Images break after live reload

## Summary
Images appear broken after live reload triggers, especially on startup or after recovering from an error page.

## Observed Behavior
- Start Basil → images break
- Make non-breaking change → images work  
- Code error shows error page → fix code → images break
- Manual browser refresh → images work
- Second code change after fix → images work

## Expected Behavior
Images should load correctly after every live reload trigger.

## Reproduction Steps
1. Create a Parsley project with images on the page
2. Start Basil in dev mode
3. Open browser to the page
4. Observe images may be broken on first load
5. Make a code change to trigger reload
6. Images may break again

## Environment
- OS: macOS
- Go version: 1.24+
- Basil version: v0.2.0

---

## Investigation Notes

### Root Cause
The live reload script started polling immediately when injected, without waiting for the page to fully load. This caused a race condition:

1. HTML parses, live reload script starts
2. First poll captures `lastSeq = N`
3. Browser starts loading images
4. If file changes occur, `seq` becomes `N+1`
5. Next poll sees `seq !== lastSeq`, triggers `location.reload()`
6. **Reload aborts in-flight image requests**
7. Images appear broken

The pattern where "second change works" is explained by browser caching - after images load successfully once, they load from cache instantly on subsequent reloads.

### Affected Code
- `server/livereload.go:10-34` — Live reload script injection

## Resolution

### Fix Description
Multi-part fix for the race condition:

**Part 1: Wait for page load**
Modified the live reload script to wait for `window.onload` event before starting to poll. The `load` event fires after all resources (including images) have finished loading.

**Part 2: Fix initial sequence detection bug**
The root cause was a subtle JavaScript bug: `lastSeq` was initialized to `0`, and the check `if (lastSeq === 0)` was used to detect the first poll. However, when the server's sequence number also started at `0`, the condition `lastSeq === 0` remained true on every poll, preventing the script from ever detecting changes.

Fix: Initialize `lastSeq = -1` instead of `0`. Since server sequence numbers are always >= 0, the check `lastSeq === -1` correctly identifies only the first poll.

```javascript
// Before (buggy):
let lastSeq = 0;
if (lastSeq === 0) { lastSeq = data.seq; }  // Never triggers reload when seq starts at 0!

// After (fixed):
let lastSeq = -1;
if (lastSeq === -1) { lastSeq = data.seq; }  // Correctly captures initial seq
```

**Part 3: Remove duplicate script injection**
Error pages in `server/errors.go` were manually injecting a live reload script, but the middleware also injects one. This caused duplicate polling and race conditions. Removed manual injection from error pages.

**Part 4: Disable browser caching in dev mode**
The browser was caching HTML pages and static files, causing stale content to be served even after code changes. Added `Cache-Control: no-cache` headers for all responses in dev mode.

- `server/security.go` - Added cache-control headers in dev mode:
  - `Cache-Control: no-cache, no-store, must-revalidate`
  - `Pragma: no-cache`
  - `Expires: 0`

### Test Coverage
Manual testing - live reload behavior is browser-dependent and difficult to unit test.
