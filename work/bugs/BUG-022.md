---
id: BUG-022
title: "Local Parsley module imports require `-x` flag unnecessarily"
status: resolved
severity: medium
created: 2026-02-08
reporter: "@human"
---

# BUG-022: Local Parsley module imports require `-x` flag unnecessarily

## Summary
Importing a local Parsley module (`import @./lib/utils.pars`) requires the `-x` (allow-execute-all) flag, even though this is just loading Parsley code, not executing external scripts. The `-x` flag should only be required for `@shell` execution, not for Parsley module imports.

## Observed Behavior
```bash
$ cat main.pars
import @./lib/utils.pars
println(utils.greet("World"))

$ pars main.pars
Runtime error: line 1, column 8
  execute access denied (use --allow-execute or -x)

$ pars -x main.pars
Hello, World!  # Works with -x flag
```

## Expected Behavior
Local Parsley module imports should work without the `-x` flag:
```bash
$ pars main.pars
Hello, World!  # Should work without -x
```

The `-x` flag should only be required for:
- `@shell` command execution
- External script execution

## Reproduction Steps
1. Create a directory structure:
   ```
   project/
   ├── main.pars
   └── lib/
       └── utils.pars
   ```
2. In `lib/utils.pars`:
   ```parsley
   export let greet = fn(name) { "Hello, {name}!" }
   ```
3. In `main.pars`:
   ```parsley
   import @./lib/utils.pars
   println(utils.greet("World"))
   ```
4. Run `pars main.pars` — fails with execute access denied
5. Run `pars -x main.pars` — works

## Environment
- OS: Any
- Go version: 1.24+
- Basil version: development

---

## Investigation Notes

### Root Cause
In `pkg/parsley/evaluator/eval_expressions.go`, the `importModule()` function performs a security check using the "execute" operation for all file-based imports:

```go
// Line 266-268
if err := env.checkPathAccess(absPath, "execute"); err != nil {
    return newSecurityError("execute", err)
}
```

The `checkPathAccess` function in `eval_helpers.go` then checks `AllowExecute` or `AllowExecuteAll`, which are only set when `-x` or `--allow-execute` is provided.

The issue is that "execute" is being used for two different concepts:
1. **Module imports** — Loading and evaluating Parsley code (safe, sandboxed)
2. **Shell execution** — Running external programs via `@shell` (potentially dangerous)

These should have different permission models:
- Module imports should follow read permissions (the file is being read and interpreted)
- Shell execution should require explicit execute permission

### Affected Code
- `pkg/parsley/evaluator/eval_expressions.go:266-268` — Uses "execute" for module imports
- `pkg/parsley/evaluator/eval_helpers.go:384-393` — Default policy denies execute
- `cmd/pars/main.go:285-290` — Security policy setup

### Proposed Fix

**Option A: Use "read" permission for Parsley imports**

Change the security check in `importModule()` to use "read" instead of "execute":

```go
// Security check - module imports are reads, not executes
if err := env.checkPathAccess(absPath, "read"); err != nil {
    return newSecurityError("read", err)
}
```

This is the simplest fix. Parsley modules are just source files being read and interpreted, same as the main script.

**Option B: Add separate "import" permission**

Add a new permission type specifically for module imports:

```go
type SecurityPolicy struct {
    // ... existing fields ...
    AllowImport    []string // Allowed import directories (whitelist)
    AllowImportAll bool     // Allow all imports (default true)
}
```

This provides finer-grained control but may be over-engineering.

**Recommendation:** Option A is sufficient. The main script is already being read and evaluated; allowing imports of other Parsley files is logically equivalent.

### Security Considerations

- Parsley code runs in a sandbox — it can't execute shell commands without explicit `-x`
- File reads are already allowed by default
- The imported Parsley code is subject to the same security policy as the main script
- This change does NOT affect `@shell` execution, which would still require `-x`

### Test Coverage Needed

1. Update tests in `pkg/parsley/tests/module_cache_test.go` to not require `AllowExecuteAll: true` for basic imports
2. Add test case: import works without `-x` flag
3. Add test case: `@shell` still requires `-x` flag (regression test)
4. Add test case: `--restrict-read` blocks imports from restricted paths

## Resolution
**Status:** Fixed  
**Date:** 2025-01-15  
**Commit:** (pending commit)

### Fix Description
Changed the security check in `importModule()` function from "execute" to "read" permission. Module imports are now treated as file reads (loading and interpreting Parsley source code) rather than executions (running external programs).

**Changes made:**
1. Modified `pkg/parsley/evaluator/eval_expressions.go` line ~266 to use `checkPathAccess(absPath, "read")` instead of `checkPathAccess(absPath, "execute")`
2. Updated comment to clarify: "Security check - module imports are reads, not executes"

**Rationale:**
- Parsley modules are source files being read and interpreted, not external executables
- The main script is already read and evaluated; imports should follow the same permission model
- Imported Parsley code runs in the same sandbox with the same security policy
- This does NOT affect `@shell` execution, which still requires explicit `-x` flag

### Test Coverage
Added comprehensive test suite in `pkg/parsley/tests/import_security_test.go`:

**Tests verifying imports work without execute permission:**
- `TestImportWithoutExecutePermission` - Basic module import without `-x` flag
- `TestImportWithRelativePath` - Relative path imports (`@./lib/utils.pars`)
- `TestImportDoesNotRequireExecuteFlag` - Imports with nil security policy
- `TestNestedImportsWithoutExecute` - Nested imports (module importing another module)

**Tests verifying security still works:**
- `TestShellStillRequiresExecutePermission` - `@shell` execution still blocked without `-x`
- `TestImportWithRestrictRead` - `RestrictRead` policy still blocks imports from restricted directories

**Updated existing tests:**
- Modified all tests in `pkg/parsley/tests/module_cache_test.go` to remove unnecessary `AllowExecuteAll: true` (12 test functions updated)

All 14 import/security tests pass. All 8 module cache tests pass.

**Integration verification:**
- Created test project with `main.pars` importing `./lib/utils.pars`
- Verified `pars main.pars` works without `-x` flag
- Confirmed imports use read permission (respects `RestrictRead` policy)

## Related
- Source: BACKLOG item #58
- Report: `work/reports/PARSLEY-1.0-ALPHA-READINESS.md`
- Related: File I/O security model