---
id: BUG-012
title: "Module cache not invalidated on file change"
status: fixed
severity: high
created: 2026-01-05
reporter: "@human"
---

# BUG-012: Module cache not invalidated on file change

## Symptom
When a module has an error and the user fixes it, the old error is still displayed. The error report shows the *updated* source code but reports the *old* error message.

Example:
- Module has `people.each(...)` which errors (no `each` method)
- User changes it to `people.map(...)`
- On next request, error page shows:
  - Source code: `people.map(...)` (correct - updated)
  - Error message: "Unknown method 'each' for array" (wrong - cached)

## Root Cause
FEAT-080 changed the module cache to persist across requests for performance (allowing `@DB` bindings to be cached). However, the file watcher does not invalidate the module cache when a `.pars` file changes.

The watcher correctly detects the change and logs "handler changed: /path/to/file.pars" but doesn't call any cache invalidation.

## Affected Code
- `server/watcher.go` - `handleFileChange()` detects changes but doesn't invalidate cache
- `pkg/parsley/evaluator/evaluator.go` - `moduleCache` needs per-file invalidation

## Fix Required
1. Add `InvalidateModule(path string)` function to evaluator to remove single module from cache
2. In `watcher.handleFileChange()`, call `evaluator.InvalidateModule(path)` for `.pars`/`.parsley` files
3. Invalidate both the changed file AND any modules that imported it (transitive invalidation)

## Workaround
Restart the Basil server to clear all module caches.
