---
id: BUG-007
title: "Module caching causes stale basil.* values"
status: resolved
severity: high
created: 2025-12-02
reporter: "@human"
---

# BUG-007: Module caching causes stale basil.* values

## Summary
When `basil.*` values are accessed in a module, they get cached with the first request's values and never update for subsequent requests.

## Observed Behavior
- First request to `/dog/` shows path as `/dog/` and logs it
- Subsequent requests to `/cat/`, `/bird/`, etc. still show `/dog/`
- No new log output appears for subsequent requests
- The cached module returns stale request data

## Expected Behavior
- Each request should see its own `basil.http.request.path` value
- Logging should occur on each request
- Module exports that reference `basil.*` should reflect current request

## Reproduction Steps
1. Create a module that exports a basil value:
   ```parsley
   // helper.pars
   export path = basil.http.request.path
   log(path)
   ```
2. Import and use it in a handler:
   ```parsley
   {path} = import(@./helper.pars)
   <p>Path: {path}</p>
   ```
3. Request `/dog/` - shows "/dog/", logs "/dog/"
4. Request `/cat/` - still shows "/dog/", no new log

## Environment
- OS: macOS
- Go version: 1.24+
- Basil version: v0.2.0-31-g882268e

---
<!-- BELOW THIS LINE: AI-FOCUSED INVESTIGATION DETAILS -->

## Investigation Notes

### Root Cause
The Parsley module cache (`moduleCache.modules`) stores the evaluated result of imports. When a module is first imported:

1. `evalImport()` checks if the module is cached
2. If not, it evaluates the module and caches the result
3. The `basil` object is copied to the module environment before evaluation
4. The module evaluates `basil.http.request.path` with Request #1's data
5. This evaluated value is cached forever

Subsequent requests get the cached module dictionary, which contains the stale values from Request #1.

### The Problem
```go
// In evalImport() - pkg/parsley/evaluator/evaluator.go
if cached, ok := moduleCache.modules[absPath]; ok {
    return cached  // Returns stale data!
}
```

The cache is appropriate for module *code* (functions, constants) but not for values that depend on request context.

### Affected Code
- `pkg/parsley/evaluator/evaluator.go:7850` — Module cache check
- `pkg/parsley/evaluator/evaluator.go:7880` — Copies basil to module env
- `pkg/parsley/evaluator/evaluator.go:7905` — Caches evaluated module

### Fix Options

**Option A: Don't cache modules that access basil** 
- Complex to detect, might miss indirect access

**Option B: Clear module cache per-request**
- Simple but defeats caching benefit entirely

**Option C: Don't copy basil to modules at import time**
- Breaks the feature we just added (modules need basil access)

**Option D: Make basil values lazy/dynamic**
- Modules export functions instead of values
- `export getPath = fn() { basil.http.request.path }`
- This is a user-side workaround, not a fix

**Option E: Clear module cache from Basil handler**
- Basil (the server) clears Parsley's module cache before each request
- Preserves dev experience, modules get fresh basil each time
- Performance impact acceptable in dev mode

**Recommended: Option E** - Clear module cache per-request in Basil's handler. This is simple, correct, and the performance cost is acceptable (modules are small, parsing is fast).

## Resolution

### Fix Description
Added `ClearModuleCache()` function to the Parsley evaluator and call it from Basil's handler before each request. This ensures modules are re-evaluated with fresh `basil.*` values for each request.

### Changes
- `pkg/parsley/evaluator/evaluator.go` - Added `ClearModuleCache()` function
- `server/handler.go` - Call `evaluator.ClearModuleCache()` before building request context

### Test Coverage
Existing tests pass. The fix is verified by manual testing - changing URLs now shows correct path in modules.

## Related
- Fix commit: See git log
- Related features: FEAT-011 (basil namespace, module access)
