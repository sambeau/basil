---
id: BUG-006
title: "Images break after live reload"
status: resolved
severity: medium
created: 2025-12-01
reporter: "@human"
---

# BUG-006: Images break after live reload

## Summary
Images appear broken after live reload triggers, especially on startup or after recovering from an error page.

## Observed Behavior
- Start Basil → images break
- Make non-breaking change → images work  
- Code error shows error page → fix code → images break
- Manual browser refresh → images work
- Second code change after fix → images work

## Expected Behavior
Images should load correctly after every live reload trigger.

## Reproduction Steps
1. Create a Parsley project with images on the page
2. Start Basil in dev mode
3. Open browser to the page
4. Observe images may be broken on first load
5. Make a code change to trigger reload
6. Images may break again

## Environment
- OS: macOS
- Go version: 1.24+
- Basil version: v0.2.0

---

## Investigation Notes

### Root Cause
The live reload script started polling immediately when injected, without waiting for the page to fully load. This caused a race condition:

1. HTML parses, live reload script starts
2. First poll captures `lastSeq = N`
3. Browser starts loading images
4. If file changes occur, `seq` becomes `N+1`
5. Next poll sees `seq !== lastSeq`, triggers `location.reload()`
6. **Reload aborts in-flight image requests**
7. Images appear broken

The pattern where "second change works" is explained by browser caching - after images load successfully once, they load from cache instantly on subsequent reloads.

### Affected Code
- `server/livereload.go:10-34` — Live reload script injection

## Resolution

### Fix Description
Two-part fix for the race condition:

**Part 1: Wait for page load**
Modified the live reload script to wait for `window.onload` event before starting to poll. The `load` event fires after all resources (including images) have finished loading.

**Part 2: Grace period after page load**
Added a 2-second grace period after capturing the initial seq where changes are absorbed but don't trigger reloads. This handles the case where:
1. Fixed page loads after error
2. Images start loading  
3. Editor writes backup/temp files (triggering extra change events)
4. Without grace period, these late events would trigger immediate reload

During the grace period, the script updates `lastSeq` to track changes but doesn't call `location.reload()`. After 2 seconds, normal live reload behavior resumes.

```javascript
// Key changes:
let initializing = true;
const initGracePeriod = 2000;

// On first poll, start grace period
if (lastSeq === 0) {
  lastSeq = data.seq;
  setTimeout(function() { initializing = false; }, initGracePeriod);
} else if (data.seq !== lastSeq && !initializing) {
  // Only reload after grace period
  location.reload();
} else if (data.seq !== lastSeq) {
  // During grace period, just update seq without reloading
  lastSeq = data.seq;
}
```

Both scripts updated:
- `server/livereload.go` - Main live reload script injected into HTML
- `server/errors.go` - Live reload script for dev error pages

### Test Coverage
Manual testing - live reload behavior is browser-dependent and difficult to unit test.
