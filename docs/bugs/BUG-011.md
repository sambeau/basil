---
id: BUG-011
title: "Site mode: @~ resolves to filepath root instead of handler root"
status: resolved
severity: high
created: 2025-12-11
reporter: "@human"
resolved: 2025-12-11
---

# BUG-011: Site mode: @~ resolves to filepath root instead of handler root

## Summary
In site mode (filesystem routing), the `@~` local root path is incorrectly set to the filepath root (`<handler root>/site/`) instead of the handler root (`<handler root>/`), preventing handlers from accessing sibling directories like `public/`, `components/`, etc.

## Observed Behavior
When using `@~` in a site mode handler (e.g., `site/index.pars`):
- `@~` resolves to `<handler root>/site/`
- Cannot import from `@~components/header`
- Cannot access `@~public/image.png`
- Only can access files within the `site/` directory itself

## Expected Behavior
`@~` should resolve to `<handler root>/` (the parent of the `site/` directory), allowing handlers to:
- Import components: `import @~components/header`
- Reference public assets: `@~public/image.png`
- Access any other directories at the handler root level

## Reproduction Steps

1. Create a Basil project with site mode:
   ```
   <handler root>/
   ├── site/
   │   └── index.pars
   ├── public/
   │   └── image.png
   └── components/
       └── header.pars
   ```

2. In `site/index.pars`, try to import:
   ```parsley
   import @~components/header
   ```

3. Or reference public asset:
   ```parsley
   <img src={@~public/image.png}/>
   ```

4. **Actual result**: Import/reference fails because `@~` points to `site/` instead of handler root

5. **Expected result**: Both should work, resolving relative to handler root

## Environment
- OS: macOS / Linux / Windows
- Go version: 1.24+
- Basil version: dev
- **Affects:** Site mode (confirmed) - handler-file mode may not be affected since there is no `site/` folder in that structure

---
<!-- BELOW THIS LINE: AI-FOCUSED INVESTIGATION DETAILS -->

## Investigation Notes

### Root Cause

**Location:** `server/site.go` line 156 and `server/handler.go` line 225

In site mode, when creating a synthetic route for a handler:

1. **In `server/site.go:156`:**
   ```go
   publicDir := filepath.Dir(handlerPath)
   ```
   Where `handlerPath` = `<handler root>/site/index.pars`
   So `publicDir` = `<handler root>/site/`

2. **In `server/handler.go:225`:**
   ```go
   scriptDir := filepath.Dir(h.scriptPath)
   absScriptDir, _ := filepath.Abs(scriptDir)
   env.RootPath = absScriptDir
   ```
   Where `h.scriptPath` = `<handler root>/site/index.pars`
   So `RootPath` = `<handler root>/site/` ❌

The `RootPath` (which determines where `@~` resolves) is set to the directory containing the handler file, which in site mode is `site/`. This prevents access to sibling directories at the handler root level.

**Expected behavior:** `RootPath` should be set to the handler root (parent of `site/`), which is `filepath.Dir(h.siteRoot)` where `h.siteRoot` is the absolute path to the `site/` directory.

### Affected Code

- `server/site.go:156` — Sets `publicDir` to handler's directory instead of handler root
- `server/handler.go:225` — Sets `env.RootPath` to handler's directory
- `server/site.go:22` — `newSiteHandler` receives `siteRoot` (path to `site/` dir)

### Proposed Fix

**Option 1 (Recommended):** Pass handler root information through the route
- In `site.go`, calculate handler root: `handlerRoot := filepath.Dir(h.siteRoot)`
- Set `route.PublicDir` to handler root instead of handler's directory
- Update `handler.go` to use `route.PublicDir` as `RootPath` when available

**Option 2:** Add a new field to track handler root separately
- Add `HandlerRoot` to `config.Route` structure
- Set it in site mode to `filepath.Dir(h.siteRoot)`
- Use it for `RootPath` in `handler.go`

**Option 1 is preferred** because it reuses the existing `PublicDir` field for its intended purpose and doesn't require config structure changes.

## Resolution

### Fix Description
Changed `RootPath` (`@~`) resolution in site mode to use handler root directory instead of handler file directory.

**Changes made:**

1. **server/site.go:156** — Changed `publicDir` calculation:
   ```go
   // OLD: publicDir := filepath.Dir(handlerPath) 
   // NEW: publicDir := filepath.Dir(h.siteRoot)
   ```
   This sets `route.PublicDir` to the handler root (parent of `site/`) instead of the `site/` directory itself.

2. **server/handler.go:225** — Updated `RootPath` logic to prefer `route.PublicDir`:
   ```go
   var rootPath string
   if route.PublicDir != "" {
       rootPath = route.PublicDir  // Use handler root in site mode
   } else {
       rootPath = filepath.Dir(h.scriptPath)  // Use script directory for handler-file mode
   }
   env.RootPath, _ = filepath.Abs(rootPath)
   ```

3. **server/handler.go:133** — Applied same logic to Part request handler for consistency

4. **server/api.go:51** — Applied same logic to API handler for consistency

### Test Coverage
Added `TestSiteHandler_RootPath` in `server/site_test.go`:
- Creates a site mode structure with `site/` and `components/` at handler root
- Tests that `import @~/components/header.pars` works from `site/index.pars`
- Verifies component content appears in response
- Test passes ✅

All existing tests continue to pass (256 tests, 0 failures).

## Related
- Fix commit: 112218e
- Related: Site mode routing implementation
