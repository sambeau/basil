---
id: PLAN-040
feature: FEAT-065
title: "Implementation Plan for Project Init Command"
status: draft
created: 2025-12-11
---

# Implementation Plan: FEAT-065

## Overview

Implement `basil --init <foldername>` command that scaffolds a minimal Basil project with site mode routing. Creates directory structure, starter handler, and working configuration file.

## Prerequisites

- [x] Spec written (FEAT-065)
- [x] Understand current CLI flag handling in `cmd/basil/main.go`
- [x] Understand config structure in `config/config.go`

## Tasks

### Task 1: Create Init Command Implementation

**Files:** `cmd/basil/init.go` (new)  
**Estimated effort:** Medium

Steps:
1. Create `cmd/basil/init.go` with init logic
2. Implement `runInitCommand(folderName string, stdout, stderr io.Writer) error`
3. Add folder validation logic:
   - Check if folder exists and is a file (error)
   - Check if folder exists and is not empty (error)
   - Support both relative and absolute paths
4. Implement directory creation:
   - Create `<folder>/` (if needed)
   - Create `<folder>/site/`
   - Create `<folder>/public/`
5. Implement file generation:
   - Write `<folder>/site/index.pars` with `<h1>Hello from Basil</h1>`
   - Write `<folder>/basil.yaml` with template config
6. Print success message with created structure and next steps

Template content:
```go
const indexParsContent = `<h1>Hello from Basil</h1>
`

const basilYAMLTemplate = `# Basil Configuration
# Generated by: basil --init

server:
  host: localhost
  port: 8080

# Site mode - filesystem-based routing
# Files in site/ are served at their path (e.g., site/index.pars → /)
site: ./site

# Public directory for static files (CSS, JS, images)
public_dir: ./public

logging:
  level: info
  format: text
  output: stderr
`
```

Error messages:
- `"folder '%s' exists but is a file, not a directory"`
- `"folder '%s' is not empty - use an empty folder or choose a different name"`
- `"failed to create folder '%s': %w"`
- `"failed to create file '%s': %w"`

Tests:
- Happy path: creates all files and folders
- Error: folder exists and is a file
- Error: folder exists and is not empty
- Success: folder exists and is empty (proceed)
- Success: folder doesn't exist (create it)

---

### Task 2: Integrate Init Command into CLI

**Files:** `cmd/basil/main.go`  
**Estimated effort:** Small

Steps:
1. Add `--init` flag to server flags (after line ~60):
   ```go
   initFolder = flags.String("init", "", "Create a new Basil project in the specified folder")
   ```
2. Add init command check before config loading (after version/help checks, ~line 90):
   ```go
   // Handle --init
   if *initFolder != "" {
       return runInitCommand(*initFolder, stdout, stderr)
   }
   ```
3. Update `printUsage()` to document `--init`:
   ```
   --init FOLDER      Create a new Basil project in the specified folder
   ```

Tests:
- Flag parsing works
- Init runs before server setup
- Help text includes init

---

### Task 3: Add Unit Tests

**Files:** `cmd/basil/init_test.go` (new)  
**Estimated effort:** Medium

Test cases:
- `TestInitCommand_Success` — creates all expected files and folders
- `TestInitCommand_FolderIsFile` — error if path is a file
- `TestInitCommand_FolderNotEmpty` — error if folder has files
- `TestInitCommand_FolderEmptyOK` — success if folder is empty
- `TestInitCommand_RelativePath` — works with `./myproject`
- `TestInitCommand_AbsolutePath` — works with absolute paths
- `TestInitCommand_YAMLContent` — validate YAML is valid
- `TestInitCommand_IndexContent` — validate index.pars content

Test helper:
```go
func TestInitCommand_Success(t *testing.T) {
    tmpDir := t.TempDir()
    projectName := "testproject"
    projectPath := filepath.Join(tmpDir, projectName)
    
    // Run init
    var stdout, stderr bytes.Buffer
    err := runInitCommand(projectPath, &stdout, &stderr)
    if err != nil {
        t.Fatalf("runInitCommand failed: %v", err)
    }
    
    // Verify structure
    assertFileExists(t, filepath.Join(projectPath, "basil.yaml"))
    assertFileExists(t, filepath.Join(projectPath, "site", "index.pars"))
    assertDirExists(t, filepath.Join(projectPath, "public"))
    
    // Verify content
    yamlContent := readFile(t, filepath.Join(projectPath, "basil.yaml"))
    if !strings.Contains(yamlContent, "site: ./site") {
        t.Error("YAML missing site config")
    }
    
    indexContent := readFile(t, filepath.Join(projectPath, "site", "index.pars"))
    if indexContent != "<h1>Hello from Basil</h1>\n" {
        t.Errorf("unexpected index.pars content: %q", indexContent)
    }
}
```

---

### Task 4: Add Integration Test

**Files:** `cmd/basil/main_test.go`  
**Estimated effort:** Small

Steps:
1. Add test that runs full CLI with `--init` flag
2. Verify success message printed to stdout
3. Verify project structure created correctly

Test:
```go
func TestCLI_InitCommand(t *testing.T) {
    tmpDir := t.TempDir()
    projectPath := filepath.Join(tmpDir, "myapp")
    
    var stdout, stderr bytes.Buffer
    err := run(context.Background(), []string{"--init", projectPath}, &stdout, &stderr, os.Getenv)
    if err != nil {
        t.Fatalf("init command failed: %v", err)
    }
    
    // Check success message
    output := stdout.String()
    if !strings.Contains(output, "Created new Basil project") {
        t.Error("success message not printed")
    }
    
    // Verify files exist
    if _, err := os.Stat(filepath.Join(projectPath, "basil.yaml")); err != nil {
        t.Error("basil.yaml not created")
    }
}
```

---

### Task 5: Update Documentation

**Files:** `README.md`, `docs/guide/quick-start.md`  
**Estimated effort:** Small

Steps:
1. Add `basil --init` to quick start guide
2. Update README with init example
3. Document in FAQ if relevant

Quick start addition:
```markdown
## Getting Started

Create a new project:
```bash
basil --init myproject
cd myproject
basil
```

Your site will be running at http://localhost:8080
```

---

### Task 6: Manual End-to-End Test

**Files:** N/A  
**Estimated effort:** Small

Steps:
1. Build basil: `make build`
2. Run `./basil --init /tmp/testproject`
3. Verify all files created
4. `cd /tmp/testproject && ../basil`
5. Visit http://localhost:8080
6. Verify "Hello from Basil" appears
7. Test error cases manually:
   - Init in existing non-empty folder
   - Init where path is a file

---

## Validation Checklist

- [ ] All tests pass: `go test ./...`
- [ ] Build succeeds: `make build`
- [ ] Linter passes: `golangci-lint run`
- [ ] Manual test: `basil --init /tmp/test` works
- [ ] Manual test: Can start server in created project
- [ ] Manual test: Error handling works correctly
- [ ] Help text updated
- [ ] Documentation updated
- [ ] BACKLOG.md updated with deferrals (if any)

## Progress Log

| Date | Task | Status | Notes |
|------|------|--------|-------|
| 2025-12-11 | Task 1: Init command | ✅ Complete | cmd/basil/init.go created |
| 2025-12-11 | Task 2: CLI integration | ✅ Complete | --init flag added to main.go |
| 2025-12-11 | Task 3: Unit tests | ✅ Complete | 8 tests in init_test.go, all passing |
| 2025-12-11 | Task 4: Integration test | ✅ Complete | Added to main_test.go |
| 2025-12-11 | Task 5: Documentation | ✅ Complete | Updated README and quick-start |
| 2025-12-11 | Task 6: Manual E2E test | ✅ Complete | Verified with /tmp/testbasil |

## Deferred Items

None planned. This is a complete, focused feature.

## Design Notes

### Success Message Format

```
Created new Basil project in 'myproject'

  myproject/
  ├── basil.yaml      Configuration
  ├── site/           Handlers (filesystem routing)
  │   └── index.pars  Homepage
  └── public/         Static files (CSS, JS, images)

Get started:
  cd myproject
  basil

Your site will be running at http://localhost:8080
```

### Error Handling Strategy

1. **Validation before any filesystem changes** — check everything first, then create
2. **Clear, actionable error messages** — tell user exactly what's wrong and how to fix
3. **Fail fast** — don't partially create structure on error

### File Permissions

- Folders: `0755` (rwxr-xr-x)
- Files: `0644` (rw-r--r--)

Standard Unix permissions, readable by all, writable by owner.
