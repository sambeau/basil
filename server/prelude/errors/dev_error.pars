// Environment variables available in this template:
//
// error (Dictionary)
//   .code (Integer)          - HTTP status code (e.g., 500)
//   .message (String)        - HTTP status text (e.g., "Internal Server Error")
//   .message_text (String)   - Detailed error message
//   .details (String)        - Full error details (dev mode only)
//   .file (String)           - Source file path where error occurred (if available)
//   .line (Integer)          - Line number where error occurred (if available)
//   .column (Integer)        - Column number where error occurred (if available)
//   .source (Array)          - Source code context around the error (if available)
//     Each element is a Dictionary with:
//       .number (Integer)    - Line number
//       .content (String)    - Line content
//       .is_error (Boolean)  - true if this is the error line
//   .request (Dictionary)    - Request (dev mode only)
//     .method (String)       - HTTP method (e.g., "GET")
//     .path (String)         - Request path
//     .query (String)        - Query string
//   .params (Array)          - Request parameters (dev mode only)
//     Each element is a Dictionary with:
//       .name (String)       - Parameter name
//       .value (String)      - Parameter value (redacted if sensitive, truncated if long)
//       .source (String)     - Source: "query", "form", "json", or "file"
//       .redacted (Boolean)  - true if value was redacted for security
//
// basil (Dictionary)
//   .version (String)        - Basil version
//   .dev (Boolean)           - true if in development mode

<Page>
	<div class="scroll">
		<Header
			title={error.code}
			info=""
			back=""
			subtitle={error.message}
			actions=""
		/>
		<div class="box">
			// <h4>error.code<Sp/>error.message.htmlEncode()</h4>
			if (error.message_text) {
				// <hr/>
				<h4><i class="fa-solid fa-triangle-exclamation"></i><Sp/>"Error"</h4>
				<div class="box">
					<pre class="error-message" style="background:none;">error
						.message_text
						.htmlEncode()</pre>
				</div>
			}

			if (error.source) {
				lines = error.source
				finalLineWidth = toString(lines[-1].number).length()
				errorPath = path(error.file)
				errorDir = errorPath.segments[:-1].join(" / ")
				filename = errorPath.filename
				<h5><i class="fa-solid fa-code"></i><Sp/>"Source Code"</h5>
				if (error.file) {
					<div class="location">
							<Sp/>
							<i class="fa-solid fa-file"></i>
							<Sp/>
							errorDir + " / " + <span class="bright">filename</span>
							<Sp/>
							<i class="fa-solid fa-angles-right"></i>
							<Sp/>
							<small>
								<span class="bright">error.line</span>
								" : "
								error.column
							</small>
					</div>
				}
				<table class="striped code">
					<tr class="empty"><td></td><td></td><td></td></tr>
					for (line in lines) {
						thisLineWidth = toString(line.number).length()
						let pad = if (thisLineWidth < finalLineWidth) " " else ""
						let codeLine = line.content.htmlEncode()
						if (line.is_error) {
							<tr class="error">
								<td align="right">
									"&nbsp;"
									<i class="fa-solid fa-play fa-beat-fade marker"></i>
								</td>
								<td align="right">
									<pre style="background:none !important">pad + line.number</pre>
								</td>
								<td>
									<pre style="background:none !important;position:relative;">codeLine</pre>
								</td>
								<td></td>
							</tr>
						} else {
							<tr>
								<td></td>
								<td align="right">
									<pre style="background:none !important">pad + line.number</pre>
								</td>
								<td>
									<pre style="background:none !important">codeLine</pre>
								</td>
								<td></td>
							</tr>
						}
					}
				</table>
			}
			<br/>

		</div>
		if (error.request) {
			<div class="box">
				<h5><i class="fa-solid fa-circle-question"></i><Sp/>"Request"</h5>
				<table class="tight" style="width: 0 !important">
					<tr>
						<td>"Method"</td>
						<td>
							<code style="background:none">error.request.method</code>
						</td>
					</tr>
					<tr>
						<td>"Path"</td>
						<td><code style="background:none">error.request.path</code></td>
					</tr>
					if (error.request.query) {
						<tr><td>"Query"</td><td><code style="background:none">error.request.query</code></td></tr>
					}
				</table>
				<br/>
			</div>
		}

		if (error.params && error.params.length() > 0) {
			// Helper to get icon for param source
			let sourceIcon = fn(source) {
				if (source == "query") { "üîç" }
				else if (source == "form") { "üìù" }
				else if (source == "json") { "üì¶" }
				else if (source == "file") { "üìé" }
				else { "‚ùì" }
			}
			<div class="box">
				<h5><i class="fa-solid fa-sliders"></i><Sp/>"Parameters"</h5>
				<table class="tight striped" style="width: 100%">
					<thead>
						<tr>
							<th>"Source"</th>
							<th>"Name"</th>
							<th>"Value"</th>
						</tr>
					</thead>
					<tbody>
						for (param in error.params) {
							<tr>
								<td>
									<span data-tooltip={param.source} style="border-bottom:none">
										sourceIcon(param.source)
									</span>
								</td>
								<td><code style="background:none">param.name</code></td>
								<td>
									if (param.redacted) {
										<span style="color:#e06c75" data-tooltip="Redacted for security" data-placement="left">
											<i class="fa-solid fa-lock"></i>
											" "
											param.value
										</span>
									} else if (param.source == "file") {
										<span style="color:#61afef">
											param.value
										</span>
									} else {
										<code style="background:none">param.value.htmlEncode()</code>
									}
								</td>
							</tr>
						}
					</tbody>
				</table>
				<br/>
			</div>
		}

		<div class="box">
			<h5><Logo height="28"/>"&nbsp;Basil"</h5>
				<table class="tight" style="width: 0 !important">
				<tr>
					<td>"Version"</td>
					<td><code style="background:none">"Basil " + (basil.version ~ /^version (.*?)$/)[1]</code></td>
				</tr>
				<tr>
					<td>"Mode"</td>
					<td><code style="background:none">"development"</code></td>
				</tr>
			</table>
			<br/>
		</div>
	</div>
</Page>
